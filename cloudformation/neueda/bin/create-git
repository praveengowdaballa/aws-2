#!/bin/bash

# login.........admin@local.host
# password......5iveL!fe

if (( $# < 2 ))
then
	echo "$0 <create|update> <stackName> <sshKey> <DNS Zone ID> <Domain Name>"
	exit 1
fi

action=$1
stackName=$2

if [[ -n $3 ]]
then
	sshKey=$3
else
	sshKey=steveshilling
fi

if [[ -n $4 ]]
then
	ZoneID=$4
else
	ZoneID=Z2U00Q95U7EKEA
fi

if [[ -n $5 ]]
then
	DNSName="$5"
else
	DNSName=grads.al-labs.co.uk
fi

# Get values of VPC
PubSub=$(aws cloudformation describe-stacks --stack-name ${stackName} | jq '.Stacks[].Outputs[] | select(.OutputKey == "PubSub") | .OutputValue')
VpcId=$(aws cloudformation describe-stacks --stack-name ${stackName} | jq '.Stacks[].Outputs[] | select(.OutputKey == "VpcId") | .OutputValue')
PubSecGrp=$(aws cloudformation describe-stacks --stack-name ${stackName} | jq '.Stacks[].Outputs[] | select(.OutputKey == "PubSecGrpID") | .OutputValue')
VolumeID=$(aws cloudformation describe-stacks --stack-name ${stackName}-ebs | jq '.Stacks[].Outputs[] | select(.OutputKey == "GitVolumeId") | .OutputValue')
TCSecGrpID=$(aws cloudformation describe-stacks --stack-name ${stackName}-teamcity | jq '.Stacks[].Outputs[] | select(.OutputKey == "TCSecGrpID") | .OutputValue')

aws cloudformation ${action}-stack --stack-name ${stackName}-git --template-body file://../templates/05-git.json --parameters ParameterKey=KeyPair,ParameterValue=${sshKey} ParameterKey=PubSub,ParameterValue=${PubSub} ParameterKey=VpcId,ParameterValue=${VpcId} ParameterKey=DNSZoneID,ParameterValue=${ZoneID} ParameterKey=DomainName,ParameterValue=${DNSName} ParameterKey=PubSecGrp,ParameterValue=${PubSecGrp} ParameterKey=VolumeID,ParameterValue=${VolumeID} ParameterKey=TCSecGrp,ParameterValue=${TCSecGrpID}

until aws cloudformation describe-stacks --stack-name ${stackName}-git | jq '.Stacks[].Outputs[]' 2>/dev/null
do
        echo -n "."
        sleep 30
done

aws cloudformation describe-stacks --stack-name ${stackName}-git | jq '.Stacks[].Outputs[]'
